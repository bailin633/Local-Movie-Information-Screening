<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonè¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #2980b9;
        }

        .button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .success {
            color: #27ae60;
            font-weight: bold;
        }

        .error {
            color: #e74c3c;
            font-weight: bold;
        }

        .warning {
            color: #f39c12;
            font-weight: bold;
        }

        .info {
            color: #3498db;
            font-weight: bold;
        }

        .output {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .path-input {
            width: 70%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: monospace;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ Pythonç¯å¢ƒè¯Šæ–­å·¥å…·</h1>

        <div class="section">
            <h2>å½“å‰PythonçŠ¶æ€</h2>
            <div id="python-status">
                <div class="status-item">
                    <span>Pythonå¯ç”¨æ€§:</span>
                    <span id="python-available" class="loading"></span>
                </div>
                <div class="status-item">
                    <span>Pythonè·¯å¾„:</span>
                    <span id="python-path">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>Pythonç‰ˆæœ¬:</span>
                    <span id="python-version">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>æ˜¯å¦ä¸ºæ‰“åŒ…åº”ç”¨:</span>
                    <span id="is-packaged">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>Pythonè„šæœ¬è·¯å¾„:</span>
                    <span id="script-path">æ£€æµ‹ä¸­...</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>è¯Šæ–­æ“ä½œ</h2>
            <button class="button" onclick="runDiagnosis()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="button" onclick="testPython()">ğŸ§ª æµ‹è¯•Python</button>
            <button class="button" onclick="checkScriptPath()">ğŸ“„ æ£€æŸ¥è„šæœ¬è·¯å¾„</button>
            <button class="button" onclick="checkDependencies()">ğŸ“¦ æ£€æŸ¥ä¾èµ–åº“</button>
            <button class="button" onclick="reinitializePython()">ğŸ”„ é‡æ–°åˆå§‹åŒ–Python</button>
            <button class="button" onclick="refreshStatus()">ğŸ“Š åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="section">
            <h2>Pythonä¾èµ–åº“ç®¡ç†</h2>
            <div id="dependency-status">
                <p>ç‚¹å‡»"æ£€æŸ¥ä¾èµ–åº“"æŸ¥çœ‹å½“å‰çŠ¶æ€...</p>
            </div>
            <div id="dependency-actions" style="display: none;">
                <button class="button" onclick="installAllDependencies()">ğŸ“¦ ä¸€é”®å®‰è£…æ‰€æœ‰ç¼ºå¤±åº“</button>
                <button class="button" onclick="showInstallationGuide()">ğŸ“– æŸ¥çœ‹æ‰‹åŠ¨å®‰è£…æŒ‡å—</button>
            </div>
            <div id="installation-progress" style="display: none;">
                <h3>å®‰è£…è¿›åº¦</h3>
                <div class="progress-bar">
                    <div id="progress-fill" style="width: 0%; background-color: #3498db; height: 20px; border-radius: 10px; transition: width 0.3s;"></div>
                </div>
                <div id="progress-text">å‡†å¤‡å®‰è£…...</div>
            </div>
        </div>

        <div class="section">
            <h2>æ‰‹åŠ¨è®¾ç½®Pythonè·¯å¾„</h2>
            <div class="flex-row">
                <input type="text" id="custom-python-path" class="path-input"
                       placeholder="ä¾‹å¦‚: C:\Python39\python.exe">
                <button class="button" onclick="setCustomPythonPath()">è®¾ç½®è·¯å¾„</button>
                <button class="button" onclick="browsePythonPath()">æµè§ˆ...</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                å¦‚æœè‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æŒ‡å®šPythonå¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
            </p>
        </div>

        <div class="section">
            <h2>è¯Šæ–­è¾“å‡º</h2>
            <div id="diagnostic-output" class="output">ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯...</div>
        </div>

        <div class="section">
            <h2>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>
            <div style="line-height: 1.6;">
                <p><strong>é—®é¢˜1: Pythonè¿è¡Œæ—¶ä¸å¯ç”¨</strong></p>
                <ul>
                    <li>ç¡®è®¤å·²å®‰è£…Python 3.7æˆ–æ›´é«˜ç‰ˆæœ¬</li>
                    <li>æ£€æŸ¥Pythonæ˜¯å¦æ·»åŠ åˆ°ç³»ç»ŸPATHç¯å¢ƒå˜é‡</li>
                    <li>å°è¯•é‡å¯åº”ç”¨ç¨‹åº</li>
                    <li>ä½¿ç”¨ä¸Šæ–¹çš„æ‰‹åŠ¨è®¾ç½®åŠŸèƒ½æŒ‡å®šPythonè·¯å¾„</li>
                </ul>

                <p><strong>é—®é¢˜2: æ‰«æç›®å½•å¤±è´¥</strong></p>
                <ul>
                    <li>ç¡®è®¤Pythonå¯ä»¥æ­£å¸¸è¿è¡Œ</li>
                    <li>æ£€æŸ¥ç›®å½•æƒé™</li>
                    <li>å°è¯•å‡å°‘æ‰«ææ·±åº¦</li>
                    <li>æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                </ul>

                <p><strong>æ¨èçš„Pythonå®‰è£…æ–¹å¼:</strong></p>
                <ul>
                    <li>ä» <a href="https://www.python.org/downloads/" target="_blank">python.org</a> ä¸‹è½½å®˜æ–¹å®‰è£…åŒ…</li>
                    <li>å®‰è£…æ—¶å‹¾é€‰"Add Python to PATH"é€‰é¡¹</li>
                    <li>é€‰æ‹©"Install for all users"ï¼ˆå¦‚æœæœ‰ç®¡ç†å‘˜æƒé™ï¼‰</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // é¡µé¢åŠ è½½æ—¶åˆ·æ–°çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
        });

        async function refreshStatus() {
            try {
                const result = await ipcRenderer.invoke('get-python-info');
                updatePythonStatus(result);

                // åŒæ—¶è·å–è„šæœ¬è·¯å¾„ä¿¡æ¯
                const scriptInfo = await ipcRenderer.invoke('get-python-script-info');
                updateScriptPathStatus(scriptInfo);
            } catch (error) {
                console.error('è·å–Pythonä¿¡æ¯å¤±è´¥:', error);
                updatePythonStatus({ available: false, error: error.message });
            }
        }

        function updatePythonStatus(info) {
            const availableEl = document.getElementById('python-available');
            const pathEl = document.getElementById('python-path');
            const versionEl = document.getElementById('python-version');
            const packagedEl = document.getElementById('is-packaged');

            if (info.available) {
                availableEl.textContent = 'âœ… å¯ç”¨';
                availableEl.className = 'success';
                pathEl.textContent = info.path || 'æœªçŸ¥';
                versionEl.textContent = info.version || 'æœªçŸ¥';
            } else {
                availableEl.textContent = 'âŒ ä¸å¯ç”¨';
                availableEl.className = 'error';
                pathEl.textContent = info.error || 'æœªæ£€æµ‹åˆ°';
                versionEl.textContent = 'æ— æ³•è·å–';
            }

            packagedEl.textContent = info.isPackaged ? 'æ˜¯' : 'å¦';
        }

        function updateScriptPathStatus(scriptInfo) {
            const scriptPathEl = document.getElementById('script-path');

            if (scriptInfo.success && scriptInfo.foundScriptPath) {
                scriptPathEl.textContent = scriptInfo.foundScriptPath;
                scriptPathEl.className = 'success';
            } else {
                scriptPathEl.textContent = 'âŒ æœªæ‰¾åˆ°';
                scriptPathEl.className = 'error';
            }
        }

        async function runDiagnosis() {
            const outputEl = document.getElementById('diagnostic-output');
            outputEl.textContent = 'æ­£åœ¨è¿è¡Œè¯Šæ–­ï¼Œè¯·ç¨å€™...\n';

            try {
                const result = await ipcRenderer.invoke('diagnose-python');
                if (result.success) {
                    outputEl.textContent = result.output;
                } else {
                    outputEl.textContent = `è¯Šæ–­å¤±è´¥: ${result.error}`;
                }
            } catch (error) {
                outputEl.textContent = `è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
            }
        }

        async function testPython() {
            const outputEl = document.getElementById('diagnostic-output');
            outputEl.textContent = 'æ­£åœ¨æµ‹è¯•Python...\n';

            try {
                const result = await ipcRenderer.invoke('test-python');
                outputEl.textContent = `Pythonæµ‹è¯•ç»“æœ:\n${JSON.stringify(result, null, 2)}`;

                // æ›´æ–°çŠ¶æ€
                await refreshStatus();
            } catch (error) {
                outputEl.textContent = `Pythonæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        async function checkScriptPath() {
            const outputEl = document.getElementById('diagnostic-output');
            outputEl.textContent = 'æ­£åœ¨æ£€æŸ¥Pythonè„šæœ¬è·¯å¾„...\n';

            try {
                const result = await ipcRenderer.invoke('get-python-script-info');

                let output = 'Pythonè„šæœ¬è·¯å¾„æ£€æŸ¥ç»“æœ:\n\n';
                output += `åº”ç”¨ç¨‹åºå·²æ‰“åŒ…: ${result.isPackaged}\n`;
                output += `åº”ç”¨ç¨‹åºè·¯å¾„: ${result.execPath}\n`;
                output += `èµ„æºè·¯å¾„: ${result.resourcesPath}\n`;
                output += `__dirname: ${result.dirname}\n\n`;

                if (result.foundScriptPath) {
                    output += `âœ… æ‰¾åˆ°Pythonè„šæœ¬: ${result.foundScriptPath}\n\n`;
                } else {
                    output += `âŒ æœªæ‰¾åˆ°Pythonè„šæœ¬\n\n`;
                }

                output += 'æ‰€æœ‰å°è¯•çš„è·¯å¾„:\n';
                result.allPaths.forEach((pathInfo, index) => {
                    const status = pathInfo.exists ? 'âœ…' : 'âŒ';
                    output += `${index + 1}. ${status} ${pathInfo.path}\n`;
                });

                outputEl.textContent = output;

                // æ›´æ–°çŠ¶æ€
                await refreshStatus();
            } catch (error) {
                outputEl.textContent = `æ£€æŸ¥è„šæœ¬è·¯å¾„å¤±è´¥: ${error.message}`;
            }
        }

        async function reinitializePython() {
            const outputEl = document.getElementById('diagnostic-output');
            outputEl.textContent = 'æ­£åœ¨é‡æ–°åˆå§‹åŒ–Pythonç®¡ç†å™¨...\n';

            try {
                const result = await ipcRenderer.invoke('reinitialize-python');
                if (result.success) {
                    outputEl.textContent = `é‡æ–°åˆå§‹åŒ–æˆåŠŸ:\n${JSON.stringify(result.info, null, 2)}`;
                    await refreshStatus();
                } else {
                    outputEl.textContent = `é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${result.error}`;
                }
            } catch (error) {
                outputEl.textContent = `é‡æ–°åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
            }
        }

        async function setCustomPythonPath() {
            const pathInput = document.getElementById('custom-python-path');
            const customPath = pathInput.value.trim();

            if (!customPath) {
                alert('è¯·è¾“å…¥Pythonè·¯å¾„');
                return;
            }

            const outputEl = document.getElementById('diagnostic-output');
            outputEl.textContent = `æ­£åœ¨è®¾ç½®è‡ªå®šä¹‰Pythonè·¯å¾„: ${customPath}\n`;

            try {
                const result = await ipcRenderer.invoke('set-python-path', customPath);
                if (result.success) {
                    outputEl.textContent += `è®¾ç½®æˆåŠŸï¼\n`;
                    await refreshStatus();
                } else {
                    outputEl.textContent += `è®¾ç½®å¤±è´¥: ${result.error}\n`;
                }
            } catch (error) {
                outputEl.textContent += `è®¾ç½®è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\n`;
            }
        }

        async function browsePythonPath() {
            try {
                const result = await ipcRenderer.invoke('show-open-dialog', {
                    title: 'é€‰æ‹©Pythonå¯æ‰§è¡Œæ–‡ä»¶',
                    filters: [
                        { name: 'Pythonå¯æ‰§è¡Œæ–‡ä»¶', extensions: ['exe'] },
                        { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }
                    ],
                    properties: ['openFile']
                });

                if (!result.canceled && result.filePaths.length > 0) {
                    document.getElementById('custom-python-path').value = result.filePaths[0];
                }
            } catch (error) {
                console.error('æµè§ˆæ–‡ä»¶å¤±è´¥:', error);
                alert('æµè§ˆæ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // Pythonä¾èµ–åº“ç®¡ç†å‡½æ•°
        async function checkDependencies() {
            const outputEl = document.getElementById('diagnostic-output');
            const statusEl = document.getElementById('dependency-status');
            const actionsEl = document.getElementById('dependency-actions');

            outputEl.textContent = 'æ­£åœ¨æ£€æŸ¥Pythonä¾èµ–åº“...\n';
            statusEl.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>';

            try {
                const result = await ipcRenderer.invoke('check-python-dependencies');

                if (result.success) {
                    let statusHtml = '<h3>ä¾èµ–åº“çŠ¶æ€</h3>';

                    result.packages.forEach(pkg => {
                        const status = pkg.installed ? 'âœ…' : 'âŒ';
                        const essential = pkg.essential ? '(å¿…éœ€)' : '(å¯é€‰)';
                        statusHtml += `<div class="status-item">
                            <span>${status} ${pkg.name} ${essential}</span>
                            <span>${pkg.description}</span>
                        </div>`;
                    });

                    if (result.missingEssential > 0 || result.missingOptional > 0) {
                        statusHtml += `<p class="warning">ç¼ºå¤±åº“: ${result.missingEssential} ä¸ªå¿…éœ€, ${result.missingOptional} ä¸ªå¯é€‰</p>`;
                        actionsEl.style.display = 'block';
                    } else {
                        statusHtml += '<p class="success">æ‰€æœ‰ä¾èµ–åº“éƒ½å·²å®‰è£…ï¼</p>';
                        actionsEl.style.display = 'none';
                    }

                    statusEl.innerHTML = statusHtml;
                    outputEl.textContent = `ä¾èµ–åº“æ£€æŸ¥å®Œæˆ:\n${JSON.stringify(result, null, 2)}`;
                } else {
                    statusEl.innerHTML = `<p class="error">æ£€æŸ¥å¤±è´¥: ${result.error}</p>`;
                    outputEl.textContent = `ä¾èµ–åº“æ£€æŸ¥å¤±è´¥: ${result.error}`;
                }
            } catch (error) {
                statusEl.innerHTML = `<p class="error">æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}</p>`;
                outputEl.textContent = `ä¾èµ–åº“æ£€æŸ¥é”™è¯¯: ${error.message}`;
            }
        }

        async function installAllDependencies() {
            const progressEl = document.getElementById('installation-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const outputEl = document.getElementById('diagnostic-output');

            progressEl.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'å¼€å§‹å®‰è£…...';

            // ç›‘å¬å®‰è£…è¿›åº¦
            ipcRenderer.on('install-progress', (event, progress) => {
                if (progress.type === 'status') {
                    progressText.textContent = progress.message;
                    const percent = (progress.current / progress.total) * 100;
                    progressFill.style.width = percent + '%';
                } else if (progress.type === 'stdout') {
                    outputEl.textContent += progress.data;
                } else if (progress.type === 'stderr') {
                    outputEl.textContent += `é”™è¯¯: ${progress.data}`;
                }
            });

            try {
                const result = await ipcRenderer.invoke('install-all-python-packages');

                if (result.success) {
                    progressFill.style.width = '100%';
                    progressText.textContent = 'å®‰è£…å®Œæˆï¼';
                    outputEl.textContent += `\nå®‰è£…ç»“æœ: ${result.message}\n`;

                    // é‡æ–°æ£€æŸ¥ä¾èµ–
                    setTimeout(() => {
                        checkDependencies();
                        progressEl.style.display = 'none';
                    }, 2000);
                } else {
                    progressText.textContent = 'å®‰è£…å¤±è´¥';
                    outputEl.textContent += `\nå®‰è£…å¤±è´¥: ${result.error}\n`;
                }
            } catch (error) {
                progressText.textContent = 'å®‰è£…è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
                outputEl.textContent += `\nå®‰è£…é”™è¯¯: ${error.message}\n`;
            }

            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            ipcRenderer.removeAllListeners('install-progress');
        }

        async function showInstallationGuide() {
            const outputEl = document.getElementById('diagnostic-output');

            try {
                const result = await ipcRenderer.invoke('get-installation-suggestions');

                if (result.success) {
                    const suggestions = result.suggestions;
                    let guide = '=== Pythonä¾èµ–åº“æ‰‹åŠ¨å®‰è£…æŒ‡å— ===\n\n';

                    guide += 'å®‰è£…å‰å‡†å¤‡:\n';
                    suggestions.beforeInstall.forEach((tip, index) => {
                        guide += `${index + 1}. ${tip}\n`;
                    });

                    guide += '\næ‰‹åŠ¨å®‰è£…å‘½ä»¤:\n';
                    suggestions.manualInstall.forEach((cmd, index) => {
                        guide += `${index + 1}. ${cmd}\n`;
                    });

                    guide += '\næ•…éšœæ’é™¤:\n';
                    suggestions.troubleshooting.forEach((tip, index) => {
                        guide += `${index + 1}. ${tip}\n`;
                    });

                    outputEl.textContent = guide;
                } else {
                    outputEl.textContent = `è·å–å®‰è£…æŒ‡å—å¤±è´¥: ${result.error}`;
                }
            } catch (error) {
                outputEl.textContent = `è·å–å®‰è£…æŒ‡å—é”™è¯¯: ${error.message}`;
            }
        }
    </script>
</body>
</html>
